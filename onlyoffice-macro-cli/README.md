# OnlyOffice Macro CLI

CLI-инструмент для запуска JavaScript макросов R7/OnlyOffice с комплексной проверкой синтаксиса, валидацией и linteg.

## Возможности

- ✅ **Продвинутая проверка синтаксиса**: Валидация JavaScript синтаксиса с использованием реальных движков
- ✅ **Валидация OnlyOffice API**: Комплексная проверка 890+ методов OnlyOffice API
- ✅ **Всесторонний linteg**: 6 категорий правил валидации, включая стиль, синтаксис, переменные, функции, ошибки и OnlyOffice-специфичные правила
- ✅ **Мок-выполнение**: Запуск макросов с заглушками OnlyOffice API для тестирования
- ✅ **Поддержка параметров**: Передача параметров в макросы
- ✅ **Множественные режимы вывода**: Подробный, тихий и структурированный вывод
- ✅ **Кроссплатформенность**: Поддержка Linux, macOS и Windows
- ✅ **Современные JavaScript движки**: Поддержка V8 и JavaScriptCore с автоматическим выбором

## Сборка

### Требования

- CMake 3.10 или выше
- Компилятор, совместимый с C++17
- JavaScript движок (V8 или JavaScriptCore)

#### Для движка V8 (рекомендуется)
```bash
# Ubuntu/Debian
sudo apt-get install libv8-dev

# macOS с Homebrew
brew install v8

# CentOS/RHEL/Fedora
sudo dnf install v8-devel
```

#### Для JavaScriptCore (платформы Apple)
```bash
# macOS (встроенный)
# Дополнительные пакеты не нужны

# Linux (GTK версия)
sudo apt-get install libjavascriptcoregtk-4.0-dev
```

### Шаги сборки

```bash
mkdir build
cd build
cmake ..
make -j$(nproc)
```

### Параметры сборки

```bash
# Сборка с определенным движком
cmake -DUSE_V8=ON -DUSE_JSC=OFF ..

# Сборка с тестами
cmake -DBUILD_TESTS=ON ..

# Релизная сборка
cmake -DCMAKE_BUILD_TYPE=Release ..
```

## Использование

### Базовое использование

```bash
# Запуск файла макроса
./onlyoffice-macro-cli my-macro.js

# Проверка только синтаксиса
./onlyoffice-macro-cli -c my-macro.js

# Запуск с подробным выводом
./onlyoffice-macro-cli --verbose my-macro.js
```

### Продвинутое использование

```bash
# Запуск с параметрами
./onlyoffice-macro-cli -p name=John -p age=30 my-macro.js

# Пробный запуск (только валидация)
./onlyoffice-macro-cli --dry-run my-macro.js

# Только линтинг
./onlyoffice-macro-cli --lint-only my-macro.js

# Сохранение результата в файл
./onlyoffice-macro-cli -o results.txt my-macro.js
```

### Выбор движка

Инструмент автоматически выбирает лучший доступный JavaScript движок:
- **macOS**: Предпочитает JavaScriptCore, резервный вариант V8
- **Linux/Windows**: Предпочитает V8, резервный вариант JavaScriptCore

## Параметры командной строки

| Параметр | Описание |
|----------|----------|
| `-h, --help` | Показать справочное сообщение |
| `-v, --version` | Показать информацию о версии |
| `-c, --syntax-check` | Проверить только синтаксис, не выполнять |
| `--verbose` | Включить подробный вывод |
| `--dry-run` | Парсить и валидировать, но не выполнять |
| `--lint-only` | Запустить только комплексную проверку линтинга |
| `-o, --output <file>` | Выходной файл для результатов |
| `-p, --param <key=value>` | Установить параметр для выполнения макроса |

## Примеры

### Пример 1: Базовый макрос для таблицы

```javascript
// spreadsheet-example.js
(function() {
    var oSheet = Api.GetActiveSheet();
    var oRange = oSheet.GetRange("A1:C3");
    oRange.SetValue("Привет из OnlyOffice!");
    Api.ShowMessage("Успех", "Макрос выполнен успешно");
})();
```

```bash
./onlyoffice-macro-cli examples/spreadsheet-example.js
```

### Пример 2: Макрос с параметрами

```javascript
// parameterized-macro.js
(function() {
    var name = typeof PARAMS !== 'undefined' ? PARAMS.name : 'Мир';
    var color = typeof PARAMS !== 'undefined' ? PARAMS.color : 'красный';
    
    console.log("Привет, " + name + "!");
    console.log("Используется цвет: " + color);
    
    Api.ShowMessage("Приветствие", "Привет, " + name + "!");
})();
```

```bash
./onlyoffice-macro-cli -p name=Алиса -p color=синий examples/parameterized-macro.js
```

### Пример 3: Комплексный линтинг

```bash
# Запуск всех проверок линтинга
./onlyoffice-macro-cli --lint-only examples/my-macro.js

# Вывод:
# ✓ Синтаксис корректен
# ✓ Проверки стиля пройдены
# ✓ Проверки использования переменных пройдены
# ✓ Проверки функций пройдены
# ✓ Проверки OnlyOffice API пройдены
# Предупреждения: 1
#   предупреждение на строке 5, колонка 12: Неизвестный вызов OnlyOffice API: Api.UnknownMethod
```

## Поддержка заглушек API

CLI включает заглушки для распространенных объектов OnlyOffice API:

### Поддерживаемые API

- `Api.GetActiveSheet()` - Возвращает заглушку объекта листа с расширенными возможностями
- `Api.ShowMessage(title, message)` - Выводит сообщение в консоль с форматированием
- `Api.GetActiveDocument()` - Возвращает заглушку объекта документа
- `Api.GetActivePresentation()` - Возвращает заглушку объекта презентации
- `Api.Save()` - Заглушка операции сохранения с обратной связью
- `console.log()` - Стандартный вывод в консоль

### Заглушки объектов

#### Объект листа
```javascript
var sheet = Api.GetActiveSheet();
var range = sheet.GetRange("A1:B2");
range.SetValue("Расширенная заглушка API");
console.log("Значение установлено:", range.GetValue()); // Возвращает заглушку данных
```

## Обработка ошибок

CLI предоставляет детальную информацию об ошибках:

### Коды выхода

| Код | Описание |
|-----|----------|
| 0 | Успех |
| 1 | Неверные аргументы |
| 2 | Синтаксическая ошибка |
| 3 | Ошибка времени выполнения |
| 4 | Файл не найден |
| 5 | Ошибки линтинга |
| 99 | Ошибка инициализации движка |

### Вывод ошибок

```bash
# Пример синтаксической ошибки
./onlyoffice-macro-cli broken-macro.js
# Вывод:
# ✗ Синтаксическая ошибка: SyntaxError: Неожиданный токен (строка 3, колонка 15)
#   Контекст кода: var x = function( {

# Пример ошибки линтинга
./onlyoffice-macro-cli --lint-only problematic-macro.js
# Вывод:
# ✗ Найдены ошибки линтинга: 3
#   ошибка на строке 2: Использование неопределенной переменной
#   предупреждение на строке 5: Неизвестный вызов OnlyOffice API
#   ошибка на строке 8: Функция объявлена, но не используется
```

## Разработка

### Структура проекта

```
onlyoffice-macro-cli/
├── src/
│   ├── main.cpp                 # Основная точка входа с выбором движка
│   ├── js_engine_factory.cpp    # Фабрика движков и логика выбора
│   ├── v8_engine.cpp           # Реализация JavaScript движка V8
│   ├── jsc_engine.cpp          # Реализация движка JavaScriptCore
│   ├── cli_parser.cpp          # Парсинг аргументов командной строки
│   ├── linter.cpp              # Комплексная система линтинга
│   ├── syntax_checker.cpp      # Валидация JavaScript синтаксиса
│   └── macro_runner.cpp        # Оркестрация выполнения макросов
├── include/
│   ├── js_engine_interface.h   # Интерфейс абстракции движка
│   ├── v8_engine.h            # Заголовок движка V8
│   ├── jsc_engine.h           # Заголовок движка JavaScriptCore
│   ├── linter.h               # Заголовки системы линтинга
│   └── [другие заголовки...]   # Дополнительные заголовки
├── examples/                   # Примеры файлов макросов
├── tests/                      # Модульные тесты
└── CMakeLists.txt             # Конфигурация сборки
```

### Добавление новых возможностей

Для добавления поддержки дополнительных OnlyOffice API или правил линтинга:

1. **Для новых заглушек API**: Редактируйте соответствующую реализацию движка (`v8_engine.cpp` или `jsc_engine.cpp`)
2. **Для новых правил линтинга**: Добавьте правила в соответствующие файлы правил в `src/` (например, `onlyoffice_rules.cpp`)
3. **Для новых проверок синтаксиса**: Обновите `syntax_checker.cpp` для распознавания новых паттернов
4. Добавьте примеры использования в директорию `examples/`

### Запуск тестов

```bash
# Сборка с тестами
cmake -DBUILD_TESTS=ON ..
make
ctest
```

## Содействие

1. Сделайте форк репозитория
2. Создайте ветку для новой функции
3. Добавьте тесты для новой функциональности
4. Убедитесь, что все тесты проходят
5. Отправьте pull request

 

## Устранение неполадок

### Распространенные проблемы

**Проблема**: "Ошибка инициализации движка"
**Решение**: Убедитесь, что V8 или JavaScriptCore правильно установлены и связаны

**Проблема**: Предупреждения "Неизвестный вызов OnlyOffice API"
**Решение**: Обновите список известных API в соответствующих файлах правил линтинга

**Проблема**: Сборка не удается из-за отсутствующих заголовков
**Решение**: Установите требуемые пакеты разработки JavaScript движка

**Проблема**: Проблемы с производительностью
**Решение**: Используйте релизную сборку (`cmake -DCMAKE_BUILD_TYPE=Release`) для оптимальной производительности

### Получение помощи

По вопросам и проблемам:
1. Проверьте директорию examples
2. Запустите с параметром `--verbose` для подробного вывода
3. Используйте `--syntax-check` для изоляции проблем синтаксиса
 
##  Контакты
- Сайт: [Р7-Консалт](https://r7-consult.ru/)
- Email: er@exceldb.pro
- Телефон: +7 915 258-0371
- Telegram: https://t.me/r7_js
