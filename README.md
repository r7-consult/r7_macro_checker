#  R7  Macros Checker 
**R7  Macros Checker** — это бесплатный кроссплатформенный веб-сервис для некоммерческого использования, который позволяет проверять макросы Р7-Офис.

### Архитетура решения 
 Плагин в Р7 слушает веб сервис, в который подаются команды с внешнего клиента. 
Плагин запускает проверку макросов:  

- Сервер выступает посредником между клиентом и плагином
- При открытии плагин устанавливает соединение с сервером по WebSocket
- Клиент отправляет JSON с текстом макроса через POST-запрос к серверу
- Сервер отправляет текст макроса в плагин
- Плагин выполняет макрос и возвращает результат
- Сервер отправляет результат клиенту
   

**В данном репозитории так же лежит бинарная программа onlyoffice-macro-cli для пакетной проверки синтаксиса (пре-чек, перед проверкой на запущенном экземпляре Р7)

###  Установленные программы 

- Р7-Офис
- Python не ниже 3.7 
- Fastapi

### <a name="Необходимые-компоненты"></a>Необходимые компоненты 

- Файл плагина Р7-Офис: macrotester.plugin
- Файл веб-сервера: server.py
- Файл примера: client.py


## <a name="установка-и-запуск-сервиса"></a>Установка и запуск сервиса
Скачайте файлы необходимых компонентов в выбранную директорию, например, c:/macrotester (Windows) или /home/user/macrotester (Linux, Астра линукс)

Установите плагин macrotester.plugin в Р7-Офис (Не запускать)

В командной строке (cmd) или терминале перейдите в выбранную директорию, например в Windows
```
cd c:/macrotester
```
или в Линуксе:
```
cd  /home/user/macrotester
```
### <a name="Start-server"></a>Запуск сервера

Введите в cmd или терминале
```
fastapi dev server.py
```
В случае появления ошибок может потребоваться переустановка uvicorn из Fastapi. Для этого остановите сервер (Cntrl+C) и введите:
```
pip install uvicorn[standard]
```
<b>Запустите сервер с помощью команды:</b>
```
uvicorn server:app –reload
```
Сервис запустится на порту 8000. Если необходимо изменить порт, нужно использовать расширенную команду:
```
uvicorn server:app --reload --port 8001 --host 0.0.0.0
```
В этом примере порт сервера 8001 и слушается вся сеть (--host 0.0.0.0)

Проверка работы сервера с помощью любого браузера возможна по ссылке:

http://localhost:8000

или

http://127.0.0.1:8000


### <a name="Start-server"></a>Запуск плагина в Р7-Офис

Перейдите в Р7-Офис и запустите установленный плагин
<br><br>

### <b><a name="возможности-и-примеры-работы"></a>Возможности и примеры работы

Запустите новый экземпляр cmd (Windows) или терминал (Линукс)

</b>

В командной строке (cmd) или терминале перейдите в выбранную директорию, например в Windows
```
cd c:/macrotester
```
или в Линуксе:
``
cd  /home/user/macrotester
``

Для проверки строк макроса из примера (файл client.py) введите:
```
python client.py
```
<b>В терминале отобразятся результаты проверок:</b>

```
C:\macrotester\>python client.py

Checking macro: var x = 1 + 2

{'result': 'ok'}

Checking macro: Api.GetActiveSheet().GetRange("A1").SetValue("Test");

{'result': 'ok'}

Checking macro: error ~!@

{'result': "SyntaxError: Unexpected token '~'"}


```
## Описание клиента 

 1. Используется  POST-запрос `{ 'macro': '<текст_макроса>' }` по URL `http://127.0.0.1:8000/check`. Например:

```
import requests

r = requests.post('http://127.0.0.1:8000/check', json={ 'macro': 'var x = 1 + 2' })

print(r.json())
```

2. Ответ:
- Успех: `{ 'result': 'ok' }`
- Ошибка: `{ 'result': '<текст_ошибки>' }`

##  Контакты
- Сайт: [Р7-Консалт](https://r7-consult.ru/)
- Email: er@exceldb.pro
- Телефон: +7 915 258-0371
- Telegram: https://t.me/r7_js
